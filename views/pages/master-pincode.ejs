<!DOCTYPE html>
<html lang="hi">
  <head>
    <%- include('../partials/head') %>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
 
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.1/css/dataTables.bootstrap4.min.css">
  <style>
    .dataTables_wrapper .dataTables_paginate .paginate_button.current, .dataTables_wrapper .dataTables_paginate .paginate_button.current:hover {
      color: #333 !important;
      border: 1px solid #979797;
      background-color: white;
      background: -webkit-gradient(linear, left top, left bottom, color-stop(0%, white), color-stop(100%, #dcdcdc));
      background: -webkit-linear-gradient(top, white 0%, #dcdcdc 100%);
      background: -moz-linear-gradient(top, white 0%, #dcdcdc 100%);
      background: -ms-linear-gradient(top, white 0%, #dcdcdc 100%);
      background: -o-linear-gradient(top, white 0%, #dcdcdc 100%);
      background: linear-gradient(to bottom, white 0%, #dcdcdc 100%);
  }
  
  /* Styles for better UX */
  .table tr:hover {
      background-color: rgba(0,0,0,0.02);
  }
  
  #search-input {
      border-top-right-radius: 0;
      border-bottom-right-radius: 0;
  }
  
  #button-addon2 {
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
  }
  
  .no-results-row td {
      background-color: #f8f9fa;
      border-bottom: 1px solid #dee2e6;
  }
  
  /* Add animation for row hiding/showing */
  #datatable_2 tbody tr {
      transition: all 0.3s ease;
  }
  
  /* Style for the search input */
  #search-input:focus {
      box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
      border-color: #80bdff;
  }
  
  /* Style for the search button hover */
  #button-addon2:hover {
      background-color: #e9ecef;
  }
  </style>
  
  </head>

  <body data-theme="light" class="font-nunito">
    <div id="wrapper" class="theme-cyan">

      <!-- HEADER -->
      <%- include('../partials/header') %>

      <!-- SIDEBAR -->
      <%- include('../partials/left-sidebar') %>
      <%- include('../partials/right-iconbar') %>

      <!-- MAIN CONTENT -->
      <div id="main-content">
        <div class="container-fluid">
          <div class="block-header">
            <div class="row">
              <div class="col-lg-6 col-md-6 col-sm-12">
                <h2>Chat App</h2>
                <ul class="breadcrumb">
                  <li class="breadcrumb-item">
                    <a href="/"><i class="fa fa-dashboard"></i></a>
                  </li>
                  <li class="breadcrumb-item">App</li>
                  <li class="breadcrumb-item active">Chat</li>
                </ul>
              </div>
              <div class="col-lg-6 col-md-6 col-sm-12">
                <div class="d-flex flex-row-reverse">
                  <div class="page_action">
                    <button type="button" class="btn btn-primary">
                      <i class="fa fa-download"></i> Download report
                    </button>
                    <button type="button" class="btn btn-secondary">
                      <i class="fa fa-plus"></i> Add new
                    </button>
                  </div>
                  <div class="p-2 d-flex"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Add your page-specific content here -->
    <!-- body part start -->
    <div>
      
      
        <!-- Search bar -->
        <div class="row" style="display: flex; flex-direction: row; justify-content: flex-end;">
          <div class="col-sm-3">
            <form class="d-flex">
              <div class="input-group">
                <input type="text" class="form-control" id="search-input" placeholder="Search" aria-label="Search" aria-describedby="basic-addon2">
                <button class="btn btn-soft-secondary" type="button" id="button-addon2">
                  <i class="fas fa-search"></i>
                </button>
              </div>
            </form>
          </div>
        </div>
      
        <!-- Table -->
        <div class="col-md-12 col-lg-12">
          <div class="p-3">
            <div class="card-body">
              <div class="table-responsive">
                <table class="table my-table" id="datatable_2">
                  <thead>
                    <tr>
                      <th>Sno.</th>
                      <th>Pincode</th>
                      <th>City</th>
                      <th>State / Code</th>
                      <th>Zone</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% if (pincodeData && pincodeData.length > 0) { %>
                      <% pincodeData.forEach((pincode, index) => { %>
                        <tr>
                          <td><%= (currentPage - 1) * 10 + index + 1 %></td> <!-- Adjusted for pagination -->
                          <td><%= pincode.pincode %></td>
                          <td><%= pincode.city || 'N/A' %></td>
                          <td><%= pincode.state || 'N/A' %></td>
                          <td><%= pincode.Zone || 'N/A' %></td>
                        </tr>
                      <% }); %>
                    <% } else { %>
                      <tr>
                        <td colspan="5" class="text-center">No data available</td>
                      </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>
      
              <!-- Pagination Controls -->
              <div class="d-flex justify-content-between align-items-center mt-3">
                <div class="dataTables_info">
                  Showing <%= ((currentPage - 1) * 10) + 1 %> to <%= Math.min(currentPage * 10, totalCount) %> of <%= totalCount %> entries
                </div>
                <div class="dataTables_paginate paging_simple_numbers">
                  <ul class="pagination">
                    <li class="paginate_button page-item previous <%= currentPage === 1 ? 'disabled' : '' %>">
                      <a href="/master-pincode?page=<%= currentPage - 1 %>&limit=10" class="page-link" aria-controls="datatable_2" tabindex="0">Previous</a>
                    </li>
                    
                    <% if (totalPages <= 7) { %>
                      <% for (let i = 1; i <= totalPages; i++) { %>
                        <li class="paginate_button page-item <%= i === currentPage ? 'active' : '' %>">
                          <a href="/master-pincode?page=<%= i %>&limit=10" class="page-link" aria-controls="datatable_2" tabindex="0"><%= i %></a>
                        </li>
                      <% } %>
                    <% } else { %>
                      <% if (currentPage > 3) { %>
                        <li class="paginate_button page-item <%= 1 === currentPage ? 'active' : '' %>">
                          <a href="/master-pincode?page=1&limit=10" class="page-link" aria-controls="datatable_2" tabindex="0">1</a>
                        </li>
                        <% if (currentPage > 4) { %>
                          <li class="paginate_button page-item disabled">
                            <a class="page-link" aria-controls="datatable_2" tabindex="0">...</a>
                          </li>
                        <% } %>
                      <% } %>
                      
                      <% 
                        let startPage = Math.max(1, currentPage - 1);
                        let endPage = Math.min(totalPages, currentPage + 1);
                        
                        if (currentPage <= 3) {
                          endPage = Math.min(4, totalPages);
                          startPage = 1;
                        }
                        
                        if (currentPage >= totalPages - 2) {
                          startPage = Math.max(1, totalPages - 3);
                          endPage = totalPages;
                        }
                      %>
                      
                      <% for (let i = startPage; i <= endPage; i++) { %>
                        <li class="paginate_button page-item <%= i === currentPage ? 'active' : '' %>">
                          <a href="/master-pincode?page=<%= i %>&limit=10" class="page-link" aria-controls="datatable_2" tabindex="0"><%= i %></a>
                        </li>
                      <% } %>
                      
                      <% if (currentPage < totalPages - 2) { %>
                        <% if (currentPage < totalPages - 3) { %>
                          <li class="paginate_button page-item disabled">
                            <a class="page-link" aria-controls="datatable_2" tabindex="0">...</a>
                          </li>
                        <% } %>
                        <li class="paginate_button page-item <%= totalPages === currentPage ? 'active' : '' %>">
                          <a href="/master-pincode?page=<%= totalPages %>&limit=10" class="page-link" aria-controls="datatable_2" tabindex="0"><%= totalPages %></a>
                        </li>
                      <% } %>
                    <% } %>
                    
                    <li class="paginate_button page-item next <%= currentPage === totalPages ? 'disabled' : '' %>">
                      <a href="/master-pincode?page=<%= currentPage + 1 %>&limit=10" class="page-link" aria-controls="datatable_2" tabindex="0">Next</a>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Modal -->
      <div class="modal fade" id="bulkAssignModal" tabindex="-1" aria-labelledby="bulkAssignModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header" style="background-color: #eff7fb;">
              <h5 class="modal-title" id="bulkAssignModalLabel" style="text-transform: uppercase;color: #656565;">ADD PINCODE IN MASTER</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="background-color: #f6fcff;">
              <div class="row">
                <div class="col-sm-6 mb-3">
                  <label for="pincode" class="form-label">Pincode</label>
                  <input type="text" class="form-control" id="pincode" placeholder="Enter pincode">
                </div>
                <div class="col-sm-6 mb-3">
                  <label for="city" class="form-label">City</label>
                  <input type="text" class="form-control" id="city" placeholder="Enter city">
                </div>
              </div>
              <div class="row">
                <div class="col-sm-6 mb-3">
                  <label for="state" class="form-label">State</label>
                  <input type="text" class="form-control" id="state" placeholder="Enter state">
                </div>
                <div class="col-sm-6 mb-3">
                  <label for="zone" class="form-label">Zone</label>
                  <select class="form-select" id="zone">
                    <option value="">Select Zone</option>
                    <option value="NORTH">NORTH</option>
                    <option value="NORTH_EAST">NORTH EAST</option>
                    <option value="WEST">WEST</option>
                    <option value="SOUTH">SOUTH</option>
                    <option value="CENTRAL">CENTRAL</option>
                    <option value="EAST">EAST</option>
                    <option value="CHANDIGARH">CHANDIGARH</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="modal-footer" style="border: none;background-color: #eff7fb;">
              <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary btn-sm" id="addPincodeConfirm">Confirm</button>
            </div>
          </div>
        </div>
      </div>
 
        <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
        <script src="assets/js/pages/form-wizard.js"></script>
        <script src="assets/js/app.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <script>
    document.getElementById('addPincodeConfirm').addEventListener('click', async function() {
        try {
            // Get values from form
            const pincode = document.getElementById('pincode').value.trim();
            const city = document.getElementById('city').value.trim();
            const state = document.getElementById('state').value.trim();
            const zone = document.getElementById('zone').value;
    
            // Validate inputs
            if (!pincode || !city || !state || !zone) {
                Swal.fire({
                    icon: 'error',
                    title: 'Validation Error',
                    text: 'All fields are required!'
                });
                return;
            }
    
            // Show loading
            Swal.fire({
                title: 'Adding Pincode...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
    
            // Send POST request
            const response = await axios.post('/api/master-pincode', {
                pincode,
                city,
                state,
                zone
            });
    
            // Close loading and show success
            Swal.fire({
                icon: 'success',
                title: 'Success',
                text: 'Pincode added successfully!'
            });
    
            // Close modal and reset form
            const modal = bootstrap.Modal.getInstance(document.getElementById('bulkAssignModal'));
            modal.hide();
            
            // Reset form
            document.getElementById('pincode').value = '';
            document.getElementById('city').value = '';
            document.getElementById('state').value = '';
            document.getElementById('zone').value = '';
    
        } catch (error) {
            console.error('Error:', error.response.data.error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: error.response.data.error || 'Failed to add pincode'
            });
        }
    });
    </script>
    <script>
  document.addEventListener('DOMContentLoaded', function() {
      // Initialize variables
      const searchInput = document.getElementById('search-input');
      const searchButton = document.getElementById('button-addon2');
      const tableBody = document.querySelector('#datatable_2 tbody');
      const tableRows = tableBody.getElementsByTagName('tr');
  
      function performSearch() {
          const searchTerm = searchInput.value.toLowerCase().trim();
          let hasResults = false;
  
          Array.from(tableRows).forEach(row => {
              // Get all cells in the row
              const allCells = Array.from(row.cells);
              
              // Skip header row or no-data row
              if (allCells.length <= 1) return;
  
              // Check if any cell in the row contains the search term
              const rowText = allCells
                  .map(cell => cell.textContent.toLowerCase().trim())
                  .join(' ');
              
              const matches = rowText.includes(searchTerm);
  
              // Show/hide row based on match
              row.style.display = matches || searchTerm === '' ? '' : 'none';
              if (matches) hasResults = true;
          });
  
          // Show no results message if needed
          showNoResults(!hasResults && searchTerm !== '');
          
          // Update the entries info
          updateEntriesInfo();
      }
  
      function showNoResults(show) {
          let noResultsRow = tableBody.querySelector('.no-results-row');
          
          if (show) {
              if (!noResultsRow) {
                  noResultsRow = document.createElement('tr');
                  noResultsRow.className = 'no-results-row';
                  noResultsRow.innerHTML = `
                      <td colspan="5" class="text-center py-3">
                          <div class="text-muted">
                              <i class="fas fa-search me-2"></i>
                              No matching records found
                          </div>
                          <button class="btn btn-sm btn-secondary mt-2" onclick="clearSearch()">
                              Clear Search
                          </button>
                      </td>
                  `;
                  tableBody.appendChild(noResultsRow);
              }
          } else if (noResultsRow) {
              noResultsRow.remove();
          }
      }
  
      function updateEntriesInfo() {
          const visibleRows = Array.from(tableRows).filter(row => 
              row.style.display !== 'none' && !row.classList.contains('no-results-row')
          ).length;
          
          const infoDiv = document.querySelector('.dataTables_info');
          if (infoDiv) {
              if (searchInput.value.trim() !== '') {
                  infoDiv.textContent = `Showing ${visibleRows} matching results`;
              } else {
                  // Restore original pagination info
                  const totalCount = <%= totalCount %>;
                  const currentPage = <%= currentPage %>;
                  const start = ((currentPage - 1) * 10) + 1;
                  const end = Math.min(currentPage * 10, totalCount);
                  infoDiv.textContent = `Showing ${start} to ${end} of ${totalCount} entries`;
              }
          }
      }
  
      // Clear search function
      window.clearSearch = function() {
          searchInput.value = '';
          Array.from(tableRows).forEach(row => {
              row.style.display = '';
          });
          showNoResults(false);
          updateEntriesInfo();
      }
  
      // Event Listeners
      let searchTimeout;
      searchInput.addEventListener('keyup', function(e) {
          clearTimeout(searchTimeout);
          // Add small delay for better performance
          searchTimeout = setTimeout(() => {
              performSearch();
          }, 300);
  
          if (e.key === 'Enter') {
              e.preventDefault();
          }
      });
  
      searchButton.addEventListener('click', function(e) {
          e.preventDefault();
          performSearch();
      });
  
      // Prevent form submission
      const searchForm = searchInput.closest('form');
      if (searchForm) {
          searchForm.addEventListener('submit', function(e) {
              e.preventDefault();
          });
      }
  
      // Clear search when 'x' is clicked in search input
      searchInput.addEventListener('search', function() {
          if (this.value === '') {
              clearSearch();
          }
      });
  });
  </script>
  
        </div>

        <!-- FOOTER -->
        <%- include('../partials/footer') %>
      </div>
    </div>

    <!-- SCRIPTS (Always at the bottom before </body>) -->
    <script src="/js/main.js"></script>
  </body>
</html>
